---
title: "Screening of SynCom9 strains in different phosphate treatments"
author: "Claudia Probst"
date: '`r Sys.Date()`'
output:
  html_document:
    fig_caption: yes
    fig_height: 10
    fig_width: 10
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
editor_options:
  chunk_output_type: console
---


```{r setup,include=FALSE, echo=F, message=F, warning=F}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
```

```{r packages and library,include=FALSE, echo=F, message=F, warning=F}
# Library loading, setting up misc functions

#install.packages("MESS")
#install.packages("metacoder")
#install.packages("lme4")
#install.packages("lmerTest")
#install.packages("multcomp")
#install.packages("emmeans")
#install.packages("magrittr")
#install.packages("tidyverse")
#install.packages("readxl")
#install.packages("lubridate")
#install.packages("broom")
#install.packages("dplyr")
#install.packages("stringr")
#install.packages("readr")
#install.packages("readr")
#install.packages("purrr")
#install.packages("rstatix")
#install.packages("ggthemes")
#install.packages("ggforce")
#install.packages("ggpmisc")
#install.packages("ggpubr")


#MESS for AUC function
library("MESS")
#Plotly to annotate plots and explore them
#library("plotly")

library("metacoder")

#lme4 and lmertest for stats, multcomp and lsmeans for posthoc
library("lme4")
library("lmerTest")
library("multcomp")
library("emmeans")
#Formatting and reading tools
library("magrittr")
#library("tidyverse")
library("readxl")
library("lubridate")
library("broom")
library("dplyr")
library("tidyr")
library("stringr")
library("readr")
library("purrr")
library("rstatix")
### the dplyr package gets overwritten by other packages so often it is necessary to load it specifically again when needed for exapmle like that: dplyr::select
#Plotstuff
library("ggthemes")
library("ggforce")
library("ggpubr")
library("ggpmisc")


```

```{r load data, echo=F, message=F, warning=F}
setwd("~/Desktop/MASTER Pflanzenwissenschaften/Experiments/stacker bacterial growth and absorption/stacker assay 2 /R Stacker")
Strain_Data <- read_excel("DESIGN_strains_stacker.xlsx", sheet = 4)

```

# Data plates
Read data plates from excel. First you make the treatlist indicating the treatment of each of the plates, then you read the excel with a loop function. The treatlist differs between each run and needs to be update prior loading the data.


```{r OD600, echo=F, message=F, warning=F}
results_OD600 <- data_frame()
# Provide a lookup table for plate information, treatments are spread accross sheets in the table to be read.
# in the first column describe the plates and in the second column the experiment (rep(times = # plates - 2))
treatlist_OD600 <- data_frame("Treat" =
              c("Dummy",
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM",
                "Dummy"),
  "Run" = c("NULL", rep("R1", times = 13), "NULL"), # times = all plates but without the dummy plates
  "Media" = c("NULL","1/2 TSB","NBRIP","NBRIP-BPB",rep("1/2 TSB", times = 2),"NBRIP", "NBRIP-BPB","1/2 TSB","NBRIP","NBRIP-BPB", "1/2 TSB","NBRIP", "NBRIP-BPB","NULL"),
  "Chem" = c("NULL", "NULL", rep("no phosphate", times=2),"NULL", rep("Ca(PO4)2",times=3), rep("K2HPO4",times=6), "NULL"),
"Conc" = c("NULL", rep("NULL", times=7), rep("1mM", times=3),rep("10mM", times=3), "NULL")) 

#Initialize / clear df

#Loop through sheets.

for (i in 1:nrow(treatlist_OD600)) {
  tmp_OD600 <- read_excel("Phosphate_SynCom9_Assay2_Claudia.xlsx", sheet = i, range = "B26:CU90") %>%   # change for duration runs
    dplyr::select(-`TÂ° 600`) %>% # Drop Temperature
    #pivot_longer(names_to = "Well", values_to = "Density") %>%  #Make long
    gather(key = "Well", value = "Density", 2:ncol(.)) %>%
    mutate(Treat = as.character(treatlist_OD600[i,1]), #Add treatment
    Run = as.character(treatlist_OD600[i,2]),
    Media = as.character(treatlist_OD600[i,3]),
    Chem = as.character(treatlist_OD600[i,4]),
    Conc = as.character(treatlist_OD600[i,5]))
    results_OD600 <- bind_rows(results_OD600, tmp_OD600)
}


```


```{r OD600 remove wells, echo=F, message=F, warning=F}
#Calculate the time scale from your data with the indication when each measurement was taken. In the same step you merge your data with the metadata (Strain_Data)

#Get times based on different time. 

results_OD600 %<>%
  filter(!Treat %in% "Dummy") %>%
  filter(!Density %in% "NA") %>% 
  filter(!Run %in% "R1"|!Treat %in% "1/2 TSB (no bacteria)"|!Well %in% "D7") %>%
  filter(!Run %in% "R1"|!Treat %in% "1/2 TSB"|!Well %in% c("C1","B2","E2","F2","C3","B4","E4","F4","C5","H5","A6","B6","E6", "F6","C7","A8","B8","8E","C9","H9","B10","E10","F10","C11","A12","B12","E12")) %>%
  filter(!Run %in% "R1"|!Treat %in% "1/2 TSB + Ca3(PO4)2"|!Well %in% c("H1","H3","E4","F4","A6","E6","F6","G6","H7","E8","G8","C9","H9","E10","F10","G10","C11","E12","F12","G12")) %>%
  filter(!Run %in% "R1"|!Treat %in% "1/2 TSB + K2HPO4 1mM"| !Well %in% c("C1","A2","B2","E2","F2","G2","A4","B4","E4","G4","C5","E6","F6","G6","C7","H7","A8","E8","G8","H9","A10","B10","E10","F10","G10","C11","H11","A12","B12","F12")) %>%
  filter(!Run %in% "R1"|!Treat %in% "1/2 TSB + K2HPO4 10mM"|!Well %in% c("C1","A2","E2","F2","G2","C3","H3","A4","E4","F4","G4","H5","A6","E6","F6","G6","C7","H7","E8","F8","G8","C9","H9","A10","B10","E10","F10","G10","C11","H11","A12","E12","F12","G12")) %>%
  filter(!Run %in% "R1"|!Treat %in% "NBRIP no phosphate"|!Well %in% "D9") %>%
  filter(!Run %in% "R1"|!Treat %in% "NBRIP Ca3(PO4)2"|!Well %in% c("E10","G10","A12")) %>%
  filter(!Run %in% "R1"|!Treat %in% "NBRIP-BPB Ca3(PO4)2"|!Well %in% c("H1","E2","F2","G2","H3","E4","F4","G4","H5","E6","F6","G6","H7","E8","G8","H9","E10","G10","H11","E12","A12","G12"))%>%
  filter(!Run %in% "R1"|!Treat %in% "NBRIP-BPB K2HPO4 1mM"|!Well %in% c("F2","G2","H2","H3","E4","F4","G4","H5","E6","F6","G6","H7","E8","F8","G8","H9","E10","F10","G10","H11","H12")) %>%
  filter(!Run %in% "R1"|!Treat %in% "NBRIP-BPB K2HPO4 10mM"|!Well %in% c("E2","F2","H3","F6","G6","C7","H9","E12")) %>%

  mutate(mins = difftime(Time, Time[1], units = "mins") %>% as.numeric(),
         hrs = difftime(Time, Time[1], units = "hours") %>% as.numeric()) %>%
  left_join(., Strain_Data, by ="Well")
```

```{r OD600 density increase, echo=F, message=F, warning=F}
# Calculate density increase: substract initial density from density of each time point 

results_OD600 %<>%
  filter(!Strain %in% c("Ignore","None")) %>%
  group_by(Run, Well, Treat) %>%
  mutate(Density_increase = Density - Density[1]) %>%
  ungroup %>% as.data.frame()

```

# OD 600 measurements

\vspace{5mm}

**Remark:** Pseudomonas, F112 Pseudomonas and Labrys were able to form a halo in the NBRIP-BPB Ca3(PO4)2 plate assay. Ensifer, Domibacillus, Pseudomonas, F112 Pseudomonas and Labrys were forming a halo in 10mM K2HPO4 in the plate assay. 

\vspace{5mm}
## Growth curve OD 600
\vspace{5mm}

### Growth curves of selected plates in all wells\
\vspace{5mm}

```{r OD600 growth curves all wells, echo=F, message=F, warning=F}
results_OD600 %>%  filter(Treat %in% c(
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"
                
                )) %>%  #hier kann man die unterschiedlichen Treatments vergleichen 
  ggplot(aes(x=hrs, y= Density_increase, color = Treat)) +
  geom_line(aes(linetype = Run)) +
  facet_grid(Row ~ Column, scales = "fixed") +
  theme_bw() +
  labs(x = "Time [hours]",
       y = "OD 600", 
       title = "growth curves at OD600", 
       color = "Treatment")
ggsave("OD600_all_wells.png")

```

### Growth curves of individual strains with each treatment \
\vspace{5mm}

```{r OD600 growth curves strain,  echo=F, message=F, warning=F}
results_OD600 %>%  
  mutate(Treat = factor(Treat, levels = c(
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"))) %>% 
  ggplot(aes(x=hrs, y= Density_increase, color = Treat)) +
  geom_smooth (method="auto", se=FALSE, size=0.5)+
  facet_wrap(~Strain, scales = "fixed") +
  theme_bw() +
 # scale_color_manual()+
  labs(x = "Time [hours]",
       y = "OD 600", 
       title = "Growth of Strains in response to different treatments",
       subtitle = "SynCom9", 
       color = "Treatment")
ggsave("OD600_strains_all.png")
```

```{r OD600 growth curves strain2,  echo=F, message=F, warning=F}
results_OD600 %>%  
  mutate(Treat = factor(Treat, levels = c(
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"))) %>% 
    mutate(Strain=factor(Strain, levels = c(
                "Ensifer",
                "Domibacillus",
                "Nocardioides",
                "Labrys",
                "Pseudomonas",
                "Variovorax",
                "Rhodanobacter",
                "Cupriavidus",
                "F 112 Pseudomonas")))%>%

  ggplot(aes(x=hrs, y= Density_increase, color = Treat)) +
  geom_smooth (method="auto", se=FALSE, size=0.5)+
  facet_wrap(~Strain, scales = "fixed", ncol=3) +
  theme_bw() +
 # scale_color_manual()+
  labs(x = "Time [hours]",
       y = "OD 600", 
       title = "Growth of Strains in response to different treatments",
       subtitle = "SynCom9", 
       color = "Treatment")
ggsave("OD600_strains_strain2.png")
```

### Growth curves of individual strains in TSB\
\vspace{5mm}

```{r OD600 TSB,  echo=F, message=F, warning=F}

results_OD600%>%
  mutate(Treat = factor(Treat, levels = c (
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"))) %>% 
      mutate(Strain=factor(Strain, levels = c(
                "Ensifer",
                "Domibacillus",
                "Nocardioides",
                "Labrys",
                "Pseudomonas",
                "Variovorax",
                "Rhodanobacter",
                "Cupriavidus",
                "F 112 Pseudomonas")))%>%
  
  filter(Treat%in%c("1/2 TSB (no bacteria)", "1/2 TSB","1/2 TSB + Ca3(PO4)2","1/2 TSB + K2HPO4 1mM","1/2 TSB + K2HPO4 10mM"  ))%>%
  
ggplot(aes(x=hrs, y= Density_increase, color=Treat)) +
  geom_smooth (method="auto", se=FALSE, size=0.5)+
  #stat_summary(geom = "pointrange", fun = mean, fun.max = max, fun.min = min, alpha = 0.3) +
  facet_wrap(~Strain, scales = "free", ncol=3) +
  theme_bw() +
  theme(legend.position = c("right"))+
  theme(legend.text = element_text(size=8))+
  scale_color_discrete(name = "Treatment", labels = c("Â½ TSB (-b)", "Â½ TSB", "+ Ca3(PO4)2","+ 1mM K2HPO4", "+ 10mM K2HPO4" ))+
  labs(x = "Time [hours]",
       y = "OD600", 
       title = "SynCom9 growth curves @OD600",
       subtitle= "Performance in Â½ TSB")
ggsave("OD600_strains_TSB.png",width=7, height=7)
```

### Growth curves of individual strains in no phosphate treatment\
\vspace{5mm}

```{r OD600 noP,  echo=F, message=F, warning=F}

results_OD600 %>%
  mutate(Treat = factor(Treat, levels = c ("1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"))) %>% 
        mutate(Strain=factor(Strain, levels = c(
                "Ensifer",
                "Domibacillus",
                "Nocardioides",
                "Labrys",
                "Pseudomonas",
                "Variovorax",
                "Rhodanobacter",
                "Cupriavidus",
                "F 112 Pseudomonas")))%>%
  filter(Treat%in%c( "NBRIP no phosphate", "NBRIP-BPB no phosphate")) %>%
  
ggplot(aes(x=hrs, y= Density_increase, color=Treat)) +
  geom_smooth (method="auto", se=FALSE, size=0.5)+
  # stat_summary(geom = "pointrange", fun.y = mean, fun.ymax = max, fun.ymin = min, alpha = 0.3) +
  facet_wrap(~Strain, scales = "free", ncol=3) +
  theme_bw() +
  labs(x = "Time [hours]",
       y = "OD 600", 
       title = "SynCom9 growth curves @OD600")
ggsave("OD600_strains_noP_P.png")
```

### Growth curves of individual strains in Ca3(PO4)2
\vspace{5mm}

```{r OD600 Ca, echo=F, message=F, warning=F}

results_OD600 %>%
  mutate(Treat = factor(Treat, levels = c ( 
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"))) %>% 
        mutate(Strain=factor(Strain, levels = c(
                "Ensifer",
                "Domibacillus",
                "Nocardioides",
                "Labrys",
                "Pseudomonas",
                "Variovorax",
                "Rhodanobacter",
                "Cupriavidus",
                "F 112 Pseudomonas")))%>%
  filter(Treat%in%c( "NBRIP Ca3(PO4)2", "NBRIP-BPB Ca3(PO4)2"))%>%
  
ggplot(aes(x=hrs, y= Density_increase, color=Treat)) +
  geom_smooth (method="auto", se=FALSE, size=0.5)+
  # stat_summary(geom = "pointrange", fun.y = mean, fun.ymax = max, fun.ymin = min, alpha = 0.3) +
  facet_wrap(~Strain, scales = "free", ncol=3) +
  theme_bw() +
  labs(x = "Time [hours]",
       y = "OD 600", 
       title = "SynCom9 growth curves @OD600")
ggsave("OD600_strains_Ca3(PO4).png")
```

### Growth curves of individual strains in K2HPO4\
\vspace{5mm}

```{r OD600 K2HPO4,  echo=F, message=F, warning=F}

results_OD600 %>%
  mutate(Treat = factor(Treat, levels = c (               
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"))) %>% 
        mutate(Strain=factor(Strain, levels = c(
                "Ensifer",
                "Domibacillus",
                "Nocardioides",
                "Labrys",
                "Pseudomonas",
                "Variovorax",
                "Rhodanobacter",
                "Cupriavidus",
                "F 112 Pseudomonas")))%>%
  filter(Treat%in%c( "NBRIP K2HPO4 1mM", "NBRIP-BPB K2HPO4 1mM","NBRIP K2HPO4 10mM", "NBRIP-BPB K2HPO4 10mM" ))%>%
  
ggplot(aes(x=hrs, y= Density_increase, color=Treat)) +
  geom_smooth (method="auto", se=FALSE, size=0.5)+
  # stat_summary(geom = "pointrange", fun.y = mean, fun.ymax = max, fun.ymin = min, alpha = 0.3) +
  facet_wrap(~Strain, scales = "free", ncol=3) +
  theme_bw() +
  labs(x = "Time [hours]",
       y = "OD 600", 
       title = "SynCom9 growth curves @OD600")
ggsave("OD600_strains_K2HPO4.png")
```

### Growth curves of individual strains in NBRIP-BPB medium\
\vspace{5mm}

```{r OD600 BPB,  echo=F, message=F, warning=F}

results_OD600%>%
  mutate(Treat = factor(Treat, levels = c ( 
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"))) %>% 
          mutate(Strain=factor(Strain, levels = c(
                "Ensifer",
                "Domibacillus",
                "Nocardioides",
                "Labrys",
                "Pseudomonas",
                "Variovorax",
                "Rhodanobacter",
                "Cupriavidus",
                "F 112 Pseudomonas")))%>%
  filter(Treat%in%c( "NBRIP-BPB no phosphate","NBRIP-BPB Ca3(PO4)2", "NBRIP-BPB K2HPO4 1mM", "NBRIP-BPB K2HPO4 10mM"))%>%
  
ggplot(aes(x=hrs, y= Density_increase, color=Treat)) +
  geom_smooth (method="auto", se=FALSE, size=0.5)+
  # stat_summary(geom = "pointrange", fun.y = mean, fun.ymax = max, fun.ymin = min, alpha = 0.3) +
  facet_wrap(~Strain, scales = "free", ncol=3) +
  theme_bw() +
  labs(x = "Time [hours]",
       y = "OD 600", 
       title = "SynCom9 growth curves @OD600")
ggsave("OD600_strains_BPB.png")
```

### Growth curves of individual strains in NBRIP medium\
\vspace{5mm}

```{r OD600 no BPB,  echo=F, message=F, warning=F}

results_OD600%>%
  mutate(Treat = factor(Treat, levels = c (
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"))) %>% 
          mutate(Strain=factor(Strain, levels = c(
                "Ensifer",
                "Domibacillus",
                "Nocardioides",
                "Labrys",
                "Pseudomonas",
                "Variovorax",
                "Rhodanobacter",
                "Cupriavidus",
                "F 112 Pseudomonas")))%>%
  filter(Treat%in%c( "NBRIP no phosphate","NBRIP Ca3(PO4)2", "NBRIP K2HPO4 1mM", "NBRIP K2HPO4 10mM"))%>%
  
ggplot(aes(x=hrs, y= Density_increase, color=Treat)) +
  geom_smooth (method="auto", se=FALSE, size=0.5)+
  # stat_summary(geom = "pointrange", fun.y = mean, fun.ymax = max, fun.ymin = min, alpha = 0.3) +
  facet_wrap(~Strain, scales = "free", ncol=3) +
  theme_bw() +
  labs(x = "Time [hours]",
       y = "OD 600", 
       title = "SynCom9 growth curves @OD600")
ggsave("OD600_strains_noBPB.png")
```

```{r OD600 no BPB,  echo=F, message=F, warning=F}

results_OD600%>%
  mutate(Treat = factor(Treat, levels = c (
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"))) %>% 
          mutate(Strain=factor(Strain, levels = c(
                "Ensifer",
                "Domibacillus",
                "Nocardioides",
                "Labrys",
                "Pseudomonas",
                "Variovorax",
                "Rhodanobacter",
                "Cupriavidus",
                "F 112 Pseudomonas")))%>%
  filter(Treat%in%c("NBRIP-BPB no phosphate","NBRIP-BPB Ca3(PO4)2", "NBRIP-BPB K2HPO4 1mM", "NBRIP-BPB K2HPO4 10mM", "NBRIP no phosphate","NBRIP Ca3(PO4)2", "NBRIP K2HPO4 1mM", "NBRIP K2HPO4 10mM"))%>%
  
ggplot(aes(x=hrs, y= Density_increase, color=Treat)) +
  geom_smooth (method="auto", se=FALSE, size=0.5)+
  # stat_summary(geom = "pointrange", fun.y = mean, fun.ymax = max, fun.ymin = min, alpha = 0.3) +
  facet_wrap(~Strain, scales = "free",ncol=3) +
  theme_bw() +
  labs(x = "Time [hours]",
       y = "OD 600", 
       title = "SynCom9 growth curves @OD600")
ggsave("OD600_strains_BPB/noBPB.png")
```

```{r density ODD600, echo=F, message=F, warning=F}
# Plotting desity increase
# Calculation density increase: maximal density increase of a strain in a certain treatment (highest OD value reached over time course)

OD600_results_maxDI <- results_OD600 %>% group_by(Strain, Treat, Chem, Media, Conc) %>% summarise(Density_increase_max = max(Density_increase)) 
```

```{r max density increase O600,  echo=F, message=F, warning=F}
OD600_results_maxDI %>%  
  mutate(Treat = factor(Treat, levels = c(
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM" ))) %>%   
  ggplot(aes(x= as.factor(Treat), y= Density_increase_max)) +
  # ylim(0, 1.5) +
  geom_boxplot(aes(colour = Treat), show.legend = FALSE) +
  geom_jitter(aes(colour = Treat), width = 0.1)+
  #stat_compare_means(label = "p.signif", method = "t.test", ref.group = "0", label.y = 1.5) +
  facet_wrap(~Strain, scales = "fixed",ncol=3) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = -90, hjust = 0))+
  labs(y = "max. Density increase",
       x = "", 
       title = "maximum growth in different media")
ggsave("OD600_max_density.png")
```

```{r max density increase O600 strain,  echo=F, message=F, warning=F}
OD600_results_maxDI %>%  
  mutate(Treat = factor(Treat, levels = c(
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM" ))) %>%   
  mutate(Strain=factor(Strain, levels = c(
                "Ensifer",
                "Domibacillus",
                "Nocardioides",
                "Labrys",
                "Pseudomonas",
                "Variovorax",
                "Rhodanobacter",
                "Cupriavidus",
                "F 112 Pseudomonas")))%>%
  ggplot(aes(x= as.factor(Treat), y= Density_increase_max)) +
  # ylim(0, 1.5) +
  geom_boxplot(aes(colour = Treat), show.legend = FALSE) +
  geom_jitter(aes(colour = Treat), width = 0.1)+
  #stat_compare_means(label = "p.signif", method = "t.test", ref.group = "0", label.y = 1.5) +
  facet_wrap(~Strain, scales = "fixed",ncol=3) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = -90, hjust = 0))+
  labs(y = "max. Density increase",
       x = "", 
       title = "maximum growth in different media")
ggsave("OD600_box.png")
```

```{r OD453 , echo=F, message=F, warning=F}
results_OD453 <- data_frame()
# Provide a lookup table for plate information, treatments are spread accross sheets in the table to be read.
# in the first column describe the plates and in the second column the experiment (rep(times = # plates - 2))
treatlist_OD453 <- data_frame("Treat" =
              c("Dummy",
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM",
                "Dummy"),
  "Run" = c("NULL", rep("R1", times = 13), "NULL"), # times = all plates but without the dummy plates
  "Media" = c("NULL","1/2 TSB","NBRIP","NBRIP-BPB",rep("1/2 TSB", times = 2),"NBRIP", "NBRIP-BPB","1/2 TSB","NBRIP","NBRIP-BPB", "1/2 TSB","NBRIP", "NBRIP-BPB","NULL"),
  "Chem" = c("NULL", "NULL", rep("no phosphate", times=2),"NULL", rep("Ca(PO4)2",times=3), rep("K2HPO4",times=6), "NULL"),
"Conc" = c("NULL", rep("NULL", times=7), rep("1mM", times=3),rep("10mM", times=3), "NULL")) 


#Initialize / clear df

#Loop through sheets.

for (i in 1:nrow(treatlist_OD453)) {
  tmp_OD453 <- read_excel("Phosphate_SynCom9_Assay2_Claudia.xlsx", sheet = i, range = "B1183:CU1246") %>%   # change for duration runs
    dplyr::select(-`TÂ° 453`) %>% # Drop Temperature
    #pivot_longer(names_to = "Well", values_to = "Density") %>%  #Make long
    gather(key = "Well", value = "Density", 2:ncol(.)) %>%
    mutate(Treat = as.character(treatlist_OD453[i,1]), #Add treatment
    Run = as.character(treatlist_OD453[i,2]),
    Media = as.character(treatlist_OD453[i,3]),
    Chem = as.character(treatlist_OD453[i,4]))
    results_OD453 <- bind_rows(results_OD453, tmp_OD453)
}


```

```{r OD453 remove wells, echo=F, message=F, warning=F}
# Calculate the time scale from your data with the indication when each measurement was taken. In the same step you merge your data with the metadata (Strain_Data)
###Get times based on different time. 

results_OD453 %<>%
  filter(!Treat %in% "Dummy") %>%
  filter(!Density %in% "NA") %>% 
  filter(!Run %in% "R1"|!Treat %in% "1/2 TSB (no bacteria)"|!Well %in% "D7") %>%
  filter(!Run %in% "R1"|!Treat %in% "1/2 TSB"|!Well %in% c("C1","B2","E2","F2","C3","B4","E4","F4","C5","H5","A6","B6","E6", "F6","C7","A8","B8","8E","C9","H9","B10","E10","F10","C11","A12","B12","E12")) %>%
  filter(!Run %in% "R1"|!Treat %in% "1/2 TSB + Ca3(PO4)2"|!Well %in% c("H1","H3","E4","F4","A6","E6","F6","G6","H7","E8","G8","C9","H9","E10","F10","G10","C11","E12","F12","G12")) %>%
  filter(!Run %in% "R1"|!Treat %in% "1/2 TSB + K2HPO4 1mM"| !Well %in% c("C1","A2","B2","E2","F2","G2","A4","B4","E4","G4","C5","E6","F6","G6","C7","H7","A8","E8","G8","H9","A10","B10","E10","F10","G10","C11","H11","A12","B12","F12")) %>%
  filter(!Run %in% "R1"|!Treat %in% "1/2 TSB + K2HPO4 10mM"|!Well %in% c("C1","A2","E2","F2","G2","C3","H3","A4","E4","F4","G4","H5","A6","E6","F6","G6","C7","H7","E8","F8","G8","C9","H9","A10","B10","E10","F10","G10","C11","H11","A12","E12","F12","G12")) %>%
  filter(!Run %in% "R1"|!Treat %in% "NBRIP no phosphate"|!Well %in% "D9") %>%
  filter(!Run %in% "R1"|!Treat %in% "NBRIP Ca3(PO4)2"|!Well %in% c("E10","G10","A12")) %>%
  filter(!Run %in% "R1"|!Treat %in% "NBRIP-BPB Ca3(PO4)2"|!Well %in% c("H1","E2","F2","G2","H3","E4","F4","G4","H5","E6","F6","G6","H7","E8","G8","H9","E10","G10","H11","E12","A12","G12"))%>%
  filter(!Run %in% "R1"|!Treat %in% "NBRIP-BPB K2HPO4 1mM"|!Well %in% c("F2","G2","H2","H3","E4","F4","G4","H5","E6","F6","G6","H7","E8","F8","G8","H9","E10","F10","G10","H11","H12")) %>%
  filter(!Run %in% "R1"|!Treat %in% "NBRIP-BPB K2HPO4 10mM"|!Well %in% c("E2","F2","H3","F6","G6","C7","H9","E12")) %>%

  mutate(mins = difftime(Time, Time[1], units = "mins") %>% as.numeric(),
         hrs = difftime(Time, Time[1], units = "hours") %>% as.numeric()) %>%
  left_join(., Strain_Data, by ="Well")
```

```{r OD453 density increase, echo=F, message=F, warning=F}
## Calculate density increase: substract initial density from density of each time point 
results_OD453 %<>%
  filter(!Strain %in% c("Ignore","None")) %>%
  group_by(Run, Well, Treat) %>%
  mutate(Density_increase = Density - Density[1]) %>%
  ungroup %>% as.data.frame()
```

# OD 453 measurements
\vspace{5mm}

**Remark:** Pseudomonas, F112 Pseudomonas and Labrys were able to form a halo in the NBRIP-BPB Ca3(PO4)2 plate assay. Ensifer, Domibacillus, Pseudomonas, F112 Pseudomonas and Labrys were forming a halo in 10mM K2HPO4 in the plate assay. Bromophenol blue has a peak at 453nm which correspond to low pH. We expect that strains that are able to solubilize inorganic phosphorous, are able to lower the pH by turning the treatment solution into yellow by time. For those strains we expect an exponential curve. 

\vspace{5mm}

## Growth curves
\vspace{5mm}

### Growth curves of selected plates in all wells\
\vspace{5mm}

```{r OD453 growth curves all wells,  echo=F, message=F, warning=F}
results_OD453 %>%  filter(Treat %in% c(
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"
                
                )) %>%  #hier kann man die unterschiedlichen Treatments vergleichen 
  ggplot(aes(x=hrs, y= Density_increase, color = Treat)) +
  geom_line(aes(linetype = Run)) +
  facet_grid(Row ~ Column, scales = "fixed") +
  theme_bw() +
  labs(x = "Time [hours]",
       y = "OD 453", 
       title = "growth curves at OD453", 
       color = "Treatment")
ggsave("OD453_all_wells.png")

```

### Growth curves of individual strains with each treatment \
\vspace{5mm}

```{r OD453 growth curves strains,  echo=F, message=F, warning=F}

results_OD453 %>%
  mutate(Treat = factor(Treat, levels = c ( 
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"))) %>% 
    mutate(Strain=factor(Strain, levels = c(
                "Ensifer",
                "Domibacillus",
                "Nocardioides",
                "Labrys",
                "Pseudomonas",
                "Variovorax",
                "Rhodanobacter",
                "Cupriavidus",
                "F 112 Pseudomonas")))%>%
  
ggplot(aes(x=hrs, y= Density_increase, color=Treat)) +
  geom_smooth (method="auto", se=FALSE, size=0.5)+
  # stat_summary(geom = "pointrange", fun.y = mean, fun.ymax = max, fun.ymin = min, alpha = 0.3) +
  facet_wrap(~Strain, scales = "fixed", ncol=3) +
  theme_bw() +
  labs(x = "Time [hours]",
       y = "OD 453", 
       title = "SynCom9 growth curves @OD453")
ggsave("OD453_strains.png")
```

### Growth curves of individual strains in NBRIP and NBRIP-BPB medium\
\vspace{5mm}

```{r OD453 NBRIP, echo=F, message=F, warning=F}

results_OD453 %>%
  mutate(Treat = factor(Treat, levels = c ( 
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"))) %>% 
      mutate(Strain=factor(Strain, levels = c(
                "Ensifer",
                "Domibacillus",
                "Nocardioides",
                "Labrys",
                "Pseudomonas",
                "Variovorax",
                "Rhodanobacter",
                "Cupriavidus",
                "F 112 Pseudomonas")))%>%

  filter(Treat%in%c("NBRIP Ca3(PO4)2","NBRIP-BPB Ca3(PO4)2", "NBRIP K2HPO4 1mM", "NBRIP-BPB K2HPO4 1mM","NBRIP K2HPO4 10mM", "NBRIP-BPB K2HPO4 10mM", "NBRIP no phosphate",   "NBRIP-BPB no phosphate"))%>%
ggplot(aes(x=hrs, y= Density_increase, color=Treat)) +
  geom_smooth (method="auto", se=FALSE, size=0.5)+
  # stat_summary(geom = "pointrange", fun.y = mean, fun.ymax = max, fun.ymin = min, alpha = 0.3) +
  facet_wrap(~Strain, scales = "free",ncol=3) +
  theme_bw() +
  labs(x = "Time [hours]",
       y = "OD 453", 
       title = "SynCom9 growth curves @OD453")
ggsave("OD453_strains_NBRIP.png")
```

### Growth curves of individual strains in Ca3PO4 and no P medium \
\vspace{5mm}

```{r OD453 Ca,  echo=F, message=F, warning=F}

results_OD453%>%
  mutate(Treat = factor(Treat, levels = c ( 
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"))) %>% 
        mutate(Strain=factor(Strain, levels = c(
                "Ensifer",
                "Domibacillus",
                "Nocardioides",
                "Labrys",
                "Pseudomonas",
                "Variovorax",
                "Rhodanobacter",
                "Cupriavidus",
                "F 112 Pseudomonas")))%>%
  filter(Treat%in%c("NBRIP Ca3(PO4)2","NBRIP-BPB Ca3(PO4)2","NBRIP no phosphate","NBRIP-BPB no phosphate"))%>%
  
ggplot(aes(x=hrs, y= Density_increase, color=Treat)) +
  geom_smooth (method="auto", se=FALSE, size=0.5)+
  # stat_summary(geom = "pointrange", fun.y = mean, fun.ymax = max, fun.ymin = min, alpha = 0.3) +
  facet_wrap(~Strain, scales = "free",ncol=3) +
  theme_bw() +
  labs(x = "Time [hours]",
       y = "OD 453", 
       title = "SynCom9 growth curves @OD453")
ggsave("OD453_strains_Ca.png")
```

### Growth curves of individual strains in NBRIP-BPB medium \
\vspace{5mm}

```{r OD453 BPB, echo=F, message=F, warning=F}

BPB<- results_OD453%>%
   mutate(Treat = factor(Treat, levels = c ( 
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"))) %>% 
        mutate(Strain=factor(Strain, levels = c(
                "Ensifer",
                "Domibacillus",
                "Nocardioides",
                "Labrys",
                "Pseudomonas",
                "Variovorax",
                "Rhodanobacter",
                "Cupriavidus",
                "F 112 Pseudomonas")))%>%
  filter(Treat%in%c("NBRIP-BPB no phosphate", "NBRIP-BPB Ca3(PO4)2","NBRIP-BPB K2HPO4 1mM","NBRIP-BPB K2HPO4 10mM"))%>%
  
ggplot(aes(x=hrs, y= Density_increase, color=Treat)) +
  geom_smooth (method="auto", se=FALSE, size=0.5)+
  # stat_summary(geom = "pointrange", fun.y = mean, fun.ymax = max, fun.ymin = min, alpha = 0.3) +
  facet_wrap(~Strain, scales = "free", ncol=2) +
  theme_bw() +
  scale_color_discrete(name = "Treatment", labels = c("- P", "+ Ca3(PO4)2", "+ 1mM K2HPO4","+ 10mM K2HPO4" ))+
  labs(x = "Time [hours]",
       y = "OD 453", 
       title = "NBRIP medium with BPB")+
   theme(legend.position = "none")
BPB
ggsave("OD453_strains_BPB.png",width = 5, height=7 )

```


### Growth curves of individual strains in NBRIP medium \
\vspace{5mm}

```{r no BPB,  echo=F, message=F, warning=F}

no_BPB<- results_OD453%>%
   mutate(Treat = factor(Treat, levels = c ( 
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"))) %>% 
        mutate(Strain=factor(Strain, levels = c(
                "Ensifer",
                "Domibacillus",
                "Nocardioides",
                "Labrys",
                "Pseudomonas",
                "Variovorax",
                "Rhodanobacter",
                "Cupriavidus",
                "F 112 Pseudomonas")))%>%
  filter(Treat%in%c("NBRIP no phosphate","NBRIP Ca3(PO4)2","NBRIP K2HPO4 1mM","NBRIP K2HPO4 10mM"))%>%
  
ggplot(aes(x=hrs, y= Density_increase, color=Treat)) +
  geom_smooth (method="auto", se=FALSE, size=0.5)+
  # stat_summary(geom = "pointrange", fun.y = mean, fun.ymax = max, fun.ymin = min, alpha = 0.3) +
  facet_wrap(~Strain, scales = "free", ncol=2) +
  scale_color_discrete(name = "Treatment", labels = c("- P", "+ Ca3(PO4)2", "+ 1mM K2HPO4","+ 10mM K2HPO4" ))+
  theme_bw() +
  labs(x = "Time [hours]",
       y = "OD 453", 
       title = "NBRIP medium without BPB")
no_BPB
ggsave("OD453_strains_noBPB.png",width = 5, height=7)


fig <- plot_grid(BPB + labs(colour=""),
                no_BPB + labs(colour=""),
               labels=c("A","B"),
               align = "h",
               rel_widths= c(1,1.6),
               nrow=1, ncol=2, label_size = 11)
fig
ggsave("fig.png")
```


```{r OD453 density, echo=F, message=F, warning=F}
#Plotting desity increase
#Calculation density increase: maximal density increase of a strain in a certain treatment (highest OD value reached over time course)
OD453_results_maxDI <- results_OD453 %>% group_by(Strain, Treat, Chem, Media) %>% summarise(Density_increase_max = max(Density_increase)) 
```

```{r max density increase OD453, echo=F, message=F, warning=F}
OD453_results_maxDI %>%  
  mutate(Treat = factor(Treat, levels = c ( 
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"))) %>% 
  
  ggplot(aes(x= as.factor(Treat), y= Density_increase_max)) +
  # ylim(0, 1.5) +
  geom_boxplot(aes(colour = Treat), show.legend = FALSE) +
  geom_jitter(aes(colour = Treat), width = 0.1)+
  #stat_compare_means(label = "p.signif", method = "t.test", ref.group = "0", label.y = 1.5) +
  facet_wrap(~Strain, scales = "fixed") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = -90, hjust = 0))+
  labs(y = "max. Density increase",
       x = "", 
       title = "maximum growth in different media")
ggsave("OD453_max_density.png")
```

```{r OD591,  echo=F, message=F, warning=F}

results_OD591 <- data_frame()
# Provide a lookup table for plate information, treatments are spread across sheets in the table to be read.
# in the first column describe the plates and in the second column the experiment (rep(times = # plates - 2))
treatlist_OD591 <- data_frame("Treat" =
              c("Dummy",
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM",
                "Dummy"),
  "Run" = c("NULL", rep("R1", times = 13), "NULL"), # times = all plates but without the dummy plates
  "Media" = c("NULL","1/2 TSB","NBRIP","NBRIP-BPB",rep("1/2 TSB", times = 2),"NBRIP", "NBRIP-BPB","1/2 TSB","NBRIP","NBRIP-BPB", "1/2 TSB","NBRIP", "NBRIP-BPB","NULL"),
  "Chem" = c("NULL", "NULL", rep("no phosphate", times=2),"NULL", rep("Ca(PO4)2",times=3), rep("K2HPO4",times=6), "NULL"),
"Conc" = c("NULL", rep("NULL", times=7), rep("1mM", times=3),rep("10mM", times=3), "NULL")) 

#Initialize / clear df

#Loop through sheets.

for (i in 1:nrow(treatlist_OD591)) {
  tmp_OD591<- read_excel("Phosphate_SynCom9_Assay2_Claudia.xlsx", sheet = i, range = "B2340:CU2403") %>%   # change for duration runs
    dplyr::select(-`TÂ° 591`) %>% # Drop Temperature
    #pivot_longer(names_to = "Well", values_to = "Density") %>%  #Make long
    gather(key = "Well", value = "Density", 2:ncol(.)) %>%
    mutate(Treat = as.character(treatlist_OD591[i,1]), #Add treatment
    Run = as.character(treatlist_OD591[i,2]),
    Media = as.character(treatlist_OD591[i,3]),
    Chem = as.character(treatlist_OD591[i,4]),
    Conc = as.character(treatlist_OD591[i,5]))
    results_OD591 <- bind_rows(results_OD591, tmp_OD591)
}

```


```{r OD591 remove wells,  echo=F, message=F, warning=F}
#Calculate the time scale from your data with the indication when each measurement was taken. In the same step you merge your data with the metadata (Strain_Data)
#Get times based on different time. 
results_OD591 %<>%
  filter(!Treat %in% "Dummy") %>%
  filter(!Density %in% "NA") %>% 
  filter(!Run %in% "R1"|!Treat %in% "1/2 TSB (no bacteria)"|!Well %in% "D7") %>%
  filter(!Run %in% "R1"|!Treat %in% "1/2 TSB"|!Well %in% c("C1","B2","E2","F2","C3","B4","E4","F4","C5","H5","A6","B6","E6", "F6","C7","A8","B8","8E","C9","H9","B10","E10","F10","C11","A12","B12","E12")) %>%
  filter(!Run %in% "R1"|!Treat %in% "1/2 TSB + Ca3(PO4)2"|!Well %in% c("H1","H3","E4","F4","A6","E6","F6","G6","H7","E8","G8","C9","H9","E10","F10","G10","C11","E12","F12","G12")) %>%
  filter(!Run %in% "R1"|!Treat %in% "1/2 TSB + K2HPO4 1mM"| !Well %in% c("C1","A2","B2","E2","F2","G2","A4","B4","E4","G4","C5","E6","F6","G6","C7","H7","A8","E8","G8","H9","A10","B10","E10","F10","G10","C11","H11","A12","B12","F12")) %>%
  filter(!Run %in% "R1"|!Treat %in% "1/2 TSB + K2HPO4 10mM"|!Well %in% c("C1","A2","E2","F2","G2","C3","H3","A4","E4","F4","G4","H5","A6","E6","F6","G6","C7","H7","E8","F8","G8","C9","H9","A10","B10","E10","F10","G10","C11","H11","A12","E12","F12","G12")) %>%
  filter(!Run %in% "R1"|!Treat %in% "NBRIP no phosphate"|!Well %in% "D9") %>%
  filter(!Run %in% "R1"|!Treat %in% "NBRIP Ca3(PO4)2"|!Well %in% c("E10","G10","A12")) %>%
  filter(!Run %in% "R1"|!Treat %in% "NBRIP-BPB Ca3(PO4)2"|!Well %in% c("H1","E2","F2","G2","H3","E4","F4","G4","H5","E6","F6","G6","H7","E8","G8","H9","E10","G10","H11","E12","A12","G12"))%>%
  filter(!Run %in% "R1"|!Treat %in% "NBRIP-BPB K2HPO4 1mM"|!Well %in% c("F2","G2","H2","H3","E4","F4","G4","H5","E6","F6","G6","H7","E8","F8","G8","H9","E10","F10","G10","H11","H12")) %>%
  filter(!Run %in% "R1"|!Treat %in% "NBRIP-BPB K2HPO4 10mM"|!Well %in% c("E2","F2","H3","F6","G6","C7","H9","E12")) %>%

  mutate(mins = difftime(Time, Time[1], units = "mins") %>% as.numeric(),
         hrs = difftime(Time, Time[1], units = "hours") %>% as.numeric()) %>%
  left_join(., Strain_Data, by ="Well")
```

```{r OD591 density increase,  echo=F, message=F, warning=F}
#Calculate density increase: substract initial density from density of each time point 
results_OD591 %<>%
  filter(!Strain %in% c("Ignore","None")) %>%
  group_by(Run, Well, Treat) %>%
  mutate(Density_increase = Density - Density[1]) %>%
  ungroup %>% as.data.frame()
```

# OD 591 measurements

\vspace{5mm}

**Remark:** Pseudomonas, F112 Pseudomonas and Labrys were able to form a halo in the NBRIP-BPB Ca3(PO4)2 plate assay. Ensifer, Domibacillus, Pseudomonas, F112 Pseudomonas and Labrys were forming a halo in 10mM K2HPO4 in the plate assay. Bromophenol blue has a peak at 591nm which correspond to high pH. We expect that strains that are able to solubilize inorganic phosphorous, are able to lower the pH by turning the treatment solution into yellow by time. For those strains we expect a negative exponential curve. 

\vspace{5mm}

## Growth curve OD 591
\vspace{5mm}
### Growth curves of selected plates in all wells\

```{r OD591 growth curves all wells, echo=F, message=F, warning=F}
results_OD591 %>%  filter(Treat %in% c(
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"
                
                )) %>%  #hier kann man die unterschiedlichen Treatments vergleichen 
  ggplot(aes(x=hrs, y= Density_increase, color = Treat)) +
  geom_line(aes(linetype = Run)) +
  facet_grid(Row ~ Column, scales = "fixed") +
  theme_bw() +
  labs(x = "Time [hours]",
       y = "OD 591", 
       title = "growth curves at OD591", 
       color = "Treatment")
ggsave("OD591_all_wells.png")

```

### Growth curves of individual strains with each treatment \
\vspace{5mm}

```{r OD591 growth curves strains,  echo=F, message=F, warning=F}

results_OD591 %>%
  mutate(Treat = factor(Treat, levels = c ( 
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"))) %>% 
        mutate(Strain=factor(Strain, levels = c(
                "Ensifer",
                "Domibacillus",
                "Nocardioides",
                "Labrys",
                "Pseudomonas",
                "Variovorax",
                "Rhodanobacter",
                "Cupriavidus",
                "F 112 Pseudomonas")))%>%
  
ggplot(aes(x=hrs, y= Density_increase, color=Treat)) +
  geom_smooth (method="auto", se=FALSE, size=0.5)+
  # stat_summary(geom = "pointrange", fun.y = mean, fun.ymax = max, fun.ymin = min, alpha = 0.3) +
  facet_wrap(~Strain, scales = "fixed",ncol=3) +
  theme_bw() +
  labs(x = "Time [hours]",
       y = "OD 591", 
       title = "SynCom9 growth curves @OD591")
ggsave("OD591_strains.png")
```

### Growth curves of individual strains in NBRIP and NBRIP-BPB medium \
\vspace{5mm}

```{r,OD591 NBRIP, echo=F, message=F, warning=F}

results_OD591 %>%
  mutate(Treat = factor(Treat, levels = c ( 
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"))) %>% 
        mutate(Strain=factor(Strain, levels = c(
                "Ensifer",
                "Domibacillus",
                "Nocardioides",
                "Labrys",
                "Pseudomonas",
                "Variovorax",
                "Rhodanobacter",
                "Cupriavidus",
                "F 112 Pseudomonas")))%>%
  filter(Treat%in%c("NBRIP Ca3(PO4)2","NBRIP-BPB Ca3(PO4)2", "NBRIP K2HPO4 1mM", "NBRIP-BPB K2HPO4 1mM","NBRIP K2HPO4 10mM", "NBRIP-BPB K2HPO4 10mM", "NBRIP no phosphate",   "NBRIP-BPB no phosphate"))%>%
ggplot(aes(x=hrs, y= Density_increase, color=Treat)) +
  geom_smooth (method="auto", se=FALSE, size=0.5)+
  # stat_summary(geom = "pointrange", fun.y = mean, fun.ymax = max, fun.ymin = min, alpha = 0.3) +
  facet_wrap(~Strain, scales = "free",ncol=3) +
  theme_bw() +
  labs(x = "Time [hours]",
       y = "OD 591", 
       title = "SynCom9 growth curves @OD591")
ggsave("OD591_strains_NBRIP.png")
```

### Growth curves of individual strains in NBRIP-BPB medium \
\vspace{5mm}

```{r OD591 Ca,  echo=F, message=F, warning=F}

results_OD591%>%
  mutate(Treat = factor(Treat, levels = c ( 
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"))) %>% 
        mutate(Strain=factor(Strain, levels = c(
                "Ensifer",
                "Domibacillus",
                "Nocardioides",
                "Labrys",
                "Pseudomonas",
                "Variovorax",
                "Rhodanobacter",
                "Cupriavidus",
                "F 112 Pseudomonas")))%>%
  filter(Treat%in%c("NBRIP Ca3(PO4)2","NBRIP-BPB Ca3(PO4)2","NBRIP no phosphate","NBRIP-BPB no phosphate"))%>%
  
ggplot(aes(x=hrs, y= Density_increase, color=Treat)) +
  geom_smooth (method="auto", se=FALSE, size=0.5)+
  # stat_summary(geom = "pointrange", fun.y = mean, fun.ymax = max, fun.ymin = min, alpha = 0.3) +
  facet_wrap(~Strain, scales = "free",ncol=3) +
  theme_bw() +
  labs(x = "Time [hours]",
       y = "OD 591", 
       title = "SynCom9 growth curves @OD591")
ggsave("OD591_strains_Ca.png")
```

### Growth curves of individual strains in NBRIP-BPB medium \
\vspace{5mm}

```{r OD591 BPB,  echo=F, message=F, warning=F}

results_OD591%>%
   mutate(Treat = factor(Treat, levels = c ( 
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"))) %>% 
        mutate(Strain=factor(Strain, levels = c(
                "Ensifer",
                "Domibacillus",
                "Nocardioides",
                "Labrys",
                "Pseudomonas",
                "Variovorax",
                "Rhodanobacter",
                "Cupriavidus",
                "F 112 Pseudomonas")))%>%
  filter(Treat%in%c("NBRIP-BPB no phosphate", "NBRIP-BPB Ca3(PO4)2","NBRIP-BPB K2HPO4 1mM","NBRIP-BPB K2HPO4 10mM"))%>%
  
ggplot(aes(x=hrs, y= Density_increase, color=Treat)) +
  geom_smooth (method="auto", se=FALSE, size=0.5)+
  # stat_summary(geom = "pointrange", fun.y = mean, fun.ymax = max, fun.ymin = min, alpha = 0.3) +
  facet_wrap(~Strain, scales = "free", ncol=3) +
  scale_color_discrete(name = "Treatment", labels = c("- P", "+ Ca3(PO4)2", "+ 1mM K2HPO4","+ 10mM K2HPO4" ))+
  theme_bw() +
  labs(x = "Time [hours]",
       y = "OD 591", 
       title = "SynCom9 growth curves @OD591",
       subtitle= "Strain performance in NBRIP medium supplemented with bromophenol blue")
ggsave("OD591_strains_BPB.png")
```

### Growth curves of individual strains in NBRIP medium \ 
\vspace{5mm}

```{r no BPP,  echo=F, message=F, warning=F}

results_OD591%>%
   mutate(Treat = factor(Treat, levels = c ( 
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"))) %>% 
        mutate(Strain=factor(Strain, levels = c(
                "Ensifer",
                "Domibacillus",
                "Nocardioides",
                "Labrys",
                "Pseudomonas",
                "Variovorax",
                "Rhodanobacter",
                "Cupriavidus",
                "F 112 Pseudomonas")))%>%
  filter(Treat%in%c("NBRIP no phosphate","NBRIP Ca3(PO4)2","NBRIP K2HPO4 1mM","NBRIP K2HPO4 10mM"))%>%
  
ggplot(aes(x=hrs, y= Density_increase, color=Treat)) +
  geom_smooth (method="auto", se=FALSE, size=0.5)+
  # stat_summary(geom = "pointrange", fun.y = mean, fun.ymax = max, fun.ymin = min, alpha = 0.3) +
  facet_wrap(~Strain, scales = "free", ncol=3) +
  theme_bw() +
  labs(x = "Time [hours]",
       y = "OD 591", 
       title = "SynCom9 growth curves @OD591")
ggsave("OD591_strains_noBPB.png")
```

```{r OD591 density, echo=F, message=F, warning=F}
# Plotting desity increase
#Calculation density increase: maximal density increase of a strain in a certain treatment (highest OD value reached over time course)
OD591_results_maxDI <- results_OD591 %>% group_by(Strain, Treat, Chem, Media) %>% summarise(Density_increase_max = max(Density_increase)) 
```

```{r max density increase OD591, echo=F, message=F, warning=F}
OD591_results_maxDI %>%  
  mutate(Treat = factor(Treat, levels = c ( 
                "1/2 TSB (no bacteria)",
                "NBRIP no phosphate",
                "NBRIP-BPB no phosphate",
                "1/2 TSB",
                "1/2 TSB + Ca3(PO4)2",
                "NBRIP Ca3(PO4)2", 
                "NBRIP-BPB Ca3(PO4)2",
                "1/2 TSB + K2HPO4 1mM",
                "NBRIP K2HPO4 1mM",
                "NBRIP-BPB K2HPO4 1mM",
                "1/2 TSB + K2HPO4 10mM",
                "NBRIP K2HPO4 10mM",
                "NBRIP-BPB K2HPO4 10mM"))) %>%   
  ggplot(aes(x= as.factor(Treat), y= Density_increase_max)) +
  # ylim(0, 1.5) +
  geom_boxplot(aes(colour = Treat), show.legend = FALSE) +
  geom_jitter(aes(colour = Treat), width = 0.1)+
  #stat_compare_means(label = "p.signif", method = "t.test", ref.group = "0", label.y = 1.5) +
  facet_wrap(~Strain, scales = "fixed") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = -90, hjust = 0))+
  labs(y = "max. Density increase",
       x = "", 
       title = "maximum growth in different media")
ggsave("OD591_max_density.png")
```
